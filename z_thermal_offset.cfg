[gcode_macro CALIBRATE_Z_THERMAL_COEFF_DUAL]
description: MÄƒsoarÄƒ coeficientul de dilatare termicÄƒ Z folosind senzorii chamber È™i chamber_frame
gcode:
    {% set stable_delta = params.DELTA|default(0.5)|float %}
    {% set stabilize_time = params.STABILIZE_TIME|default(600)|float %}
    {% set bed_temp = params.BED_TEMP|default(60)|float %}
    {% set nozzle_temp = params.NOZZLE_TEMP|default(200)|float %}

    {% set msg = "ğŸ”§ Pornesc mÄƒsurarea coeficientului Z (Î”T â‰¤ " ~ stable_delta|string ~ "Â°C)..." %}
    RESPOND PREFIX=0 MSG="{msg}"

    # 1ï¸âƒ£ Citire temperaturi la rece
    {% set t1_cold = printer["temperature_sensor chamber"].temperature %}
    {% set t2_cold = printer["temperature_sensor chamber_frame"].temperature %}
    {% set t_avg_cold = (t1_cold + t2_cold) / 2 %}
    {% set msg = "ğŸŒ¡ï¸ Temperaturi la rece: chamber=" ~ t1_cold|round(2)|string ~ "Â°C, frame=" ~ t2_cold|round(2)|string ~ "Â°C, medie=" ~ t_avg_cold|round(2)|string ~ "Â°C" %}
    RESPOND PREFIX=0 MSG="{msg}"

    # 2ï¸âƒ£ ÃncÄƒlzire pat + nozzle
    M140 S{bed_temp}
    M104 S{nozzle_temp}
    M190 S{bed_temp}
    M109 S{nozzle_temp}
    {% set msg = "ğŸ”¥ ÃncÄƒlzire completÄƒ, aÈ™tept stabilizare (max " ~ stabilize_time|string ~ "s)..." %}
    RESPOND PREFIX=0 MSG="{msg}"

    # 3ï¸âƒ£ AÈ™teaptÄƒ stabilizarea temperaturilor
    {% set t1_last = printer["temperature_sensor chamber"].temperature %}
    {% set t2_last = printer["temperature_sensor chamber_frame"].temperature %}
    {% set stable = False %}

    {% for i in range(0, stabilize_time|int, 10) %}
        G4 P10000
        {% set t1_now = printer["temperature_sensor chamber"].temperature %}
        {% set t2_now = printer["temperature_sensor chamber_frame"].temperature %}
        {% set diff1 = (t1_now - t1_last)|abs %}
        {% set diff2 = (t2_now - t2_last)|abs %}

        {% if diff1 < stable_delta and diff2 < stable_delta %}
            {% set stable = True %}
        {% endif %}

        {% set t1_last = t1_now %}
        {% set t2_last = t2_now %}
    {% endfor %}

    {% if stable %}
        RESPOND PREFIX=0 MSG="âœ… Temperaturile s-au stabilizat."
    {% else %}
        {% set msg = "âš ï¸ Nu s-au stabilizat complet dupÄƒ " ~ stabilize_time|string ~ "s, continui oricum..." %}
        RESPOND PREFIX=0 MSG="{msg}"
    {% endif %}

    # 4ï¸âƒ£ Citire temperaturi la cald
    {% set t1_hot = printer["temperature_sensor chamber"].temperature %}
    {% set t2_hot = printer["temperature_sensor chamber_frame"].temperature %}
    {% set t_avg_hot = (t1_hot + t2_hot) / 2 %}
    {% set msg = "ğŸ”¥ Temperaturi la cald: chamber=" ~ t1_hot|round(2)|string ~ "Â°C, frame=" ~ t2_hot|round(2)|string ~ "Â°C, medie=" ~ t_avg_hot|round(2)|string ~ "Â°C" %}
    RESPOND PREFIX=0 MSG="{msg}"

    # 5ï¸âƒ£ AfiÈ™are rezultat diferenÈ›Äƒ
    {% set delta_t = t_avg_hot - t_avg_cold %}
    {% set msg = "ğŸ“Š Î”T total = " ~ delta_t|round(2)|string ~ "Â°C. FoloseÈ™te aceastÄƒ diferenÈ›Äƒ pentru a estima temp_coeff (Î”Z / Î”T)." %}
    RESPOND PREFIX=0 MSG="{msg}"
